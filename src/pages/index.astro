---
import "../styles/global.css";

const PAGE_SIZE = 30;
let page = 1;
let cryptos = [];

try {
  const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${PAGE_SIZE}&page=${page}`);
  cryptos = await res.json();
} catch (e) {
  console.error(e);
}
---

<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Redistre Crypto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="bg-gray-900 text-gray-100 font-sans p-6 max-w-4xl mx-auto">
  <h1 class="text-4xl font-bold mb-6">Top Cryptos</h1>
  <h2 class="text-xl font-bold mb-6">Vous pouvez ici observer les cryptos du moment et quelques-unes de leurs caractéristiques. Pour plus de détails veuillez cliquer sur le nom de la crypto.</h2>
  <table class="min-w-full table-auto bg-gray-800 rounded shadow">
    <thead class="bg-gray-700 text-gray-300">
      <tr>
        <th class="p-3 text-left">#</th>
        <th class="p-3 text-left">Nom</th>
        <th class="p-3 text-left">Prix</th>
        <th class="p-3 text-left">Variation 24h</th>
        <th class="p-3 text-left">Market Cap</th>
      </tr>
    </thead>
    <tbody id="crypto-table-body">
      {cryptos.map((coin, index) => (
        <tr class="border-t border-gray-700 hover:bg-gray-700 transition" key={coin.id}>
          <td class="p-3">{index + 1}</td>
          <td class="p-3 flex items-center gap-2">
            <img src={coin.image} alt={coin.name} class="w-5 h-5" />
            <a href={`/crypto/${coin.id}`} class="hover:underline">
              {coin.name}
            </a>
            <span class="text-xs text-gray-400 ml-1">({coin.symbol.toUpperCase()})</span>
          </td>
          <td class="p-3">${coin.current_price.toLocaleString()}</td>
          <td class={`p-3 font-semibold ${coin.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'}`}>
            {coin.price_change_percentage_24h.toFixed(2)}%
          </td>
          <td class="p-3">${coin.market_cap.toLocaleString()}</td>
        </tr>
      ))}
    </tbody>
  </table>

  <button id="load-more" class="mt-6 p-3 bg-gray-700 hover:bg-gray-600 rounded w-full text-white font-semibold">
    Charger plus
  </button>

  <script type="module">
    let page = 1;
    const pageSize = 30;
    const tbody = document.getElementById('crypto-table-body');
    const btnLoadMore = document.getElementById('load-more');

    btnLoadMore.addEventListener('click', async () => {
      page++;
      btnLoadMore.disabled = true;
      btnLoadMore.textContent = 'Chargement...';

      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${pageSize}&page=${page}`);
        if (!res.ok) throw new Error('Erreur API');
        const data = await res.json();

        data.forEach((coin, index) => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700 hover:bg-gray-700 transition';
          tr.innerHTML = `
            <td class="p-3">${(page - 1) * pageSize + index + 1}</td>
            <td class="p-3 flex items-center gap-2">
              <img src="${coin.image}" alt="${coin.name}" class="w-5 h-5" />
              <a href="/crypto/${coin.id}" class="hover:underline">${coin.name}</a>
              <span class="text-xs text-gray-400 ml-1">(${coin.symbol.toUpperCase()})</span>
            </td>
            <td class="p-3">$${coin.current_price.toLocaleString()}</td>
            <td class="p-3 font-semibold ${coin.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'}">
              ${coin.price_change_percentage_24h.toFixed(2)}%
            </td>
            <td class="p-3">$${coin.market_cap.toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });

        if (data.length < pageSize) {
          btnLoadMore.textContent = 'Plus rien à charger';
          btnLoadMore.disabled = true;
        } else {
          btnLoadMore.textContent = 'Charger plus';
          btnLoadMore.disabled = false;
        }
      } catch (e) {
        btnLoadMore.textContent = 'Erreur de chargement';
        console.error(e);
      }
    });
  </script>
</body>
</html>
